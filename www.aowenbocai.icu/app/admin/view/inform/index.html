{include file='common/head' /}
<link href="__STATIC__/bootstarp-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
<script src="__STATIC__/bootstarp-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<script src="__STATIC__/bootstarp-datetimepicker/js/bootstrap-datetimepicker.zh-CN.js"></script>
<script src="__STATIC__/js/reszieimg.js"></script>
<style>
    .box-padding-bottom{margin-left: 1rem}
    input[type='checkbox'] {float: left}
</style>
<nav class="plugin_nav">
    <a  class="nav_active">通知管理</a>
    <a  href="{:url(addData)}">增加通知</a>
</nav>
<div id="app" class="box-padding">
    <div class="form-group form-group-left" style="margin:-10px 0 0 -10px;display:inline-block">
        <div class="btn-group" data-toggle="buttons" style="margin:1rem">
        <label class="btn btn-primary isdelete" data-url="{:url('isDelete', ['day' =>'1'])}">
            <input type="checkbox"> 清除全部数据
        </label>
        <label class="btn btn-primary isdelete" data-url="{:url('isDelete', ['day' =>'30'])}">
            <input type="checkbox"> 清除30天前的数据
        </label>
        <label class="btn btn-primary isdelete" data-url="{:url('isDelete', ['day' =>'15'])}">
            <input type="checkbox"> 清除15天前的数据
        </label>
        <label class="btn btn-primary isdelete" data-url="{:url('isDelete', ['day' =>'7'])}">
            <input type="checkbox"> 清除7天前的数据
        </label>
        <label class="btn btn-primary isdelete" data-url="{:url('isDelete', ['day' =>'3'])}">
            <input type="checkbox"> 清除3天前的数据
        </label>

        <label class="btn btn-primary isdelete" data-url="{:url('isDelete', ['status' =>'1'])}">
            <input type="checkbox"> 清除已读通知
        </label>

        <label class="btn btn-primary isupdate" ids = 'all'>
            <input type="checkbox"> 全部设置为已读
        </label>
        </div>
    </div>
    <div class="breadcrumb">
        <ol class="">
            <li class="active"><i class="glyphicon glyphicon-link"></i> 消息管理</li>
            <li class="active">消息列表</li>
        </ol>
        <form class="form-inline" action="">
            <div class="form-group form-group-left">
                <label>时间</label>
                <div class='input-group date' id='begintime' data-date-format="yyyy-mm-dd">
                    <input type='text' class="form-control" name="starttime" value="{$query.starttime}" />
                    <span class="input-group-addon">
                <span class="glyphicon glyphicon-calendar"></span>
            </span>
                </div>
                <label>到</label>
                <div class='input-group date' id='endtime' data-date-format="yyyy-mm-dd">
                    <input type='text' class="form-control" name="endtime" value="{$query.endtime}" />
                    <span class="input-group-addon">
            <span class="glyphicon glyphicon-calendar"></span>
            </span>
                </div>
            </div>
            <div class="form-group form-group-left">
                <label>关键字:</label>
                <input type="text" name="words" class="form-control" value="{$query.words}" placeholder="关键字/用户名/内容">
            </div>
            <button type="submit" class="btn btn-default form-group-left btn-sm">搜索</button>
        </form>
    </div>
    <div class="clear"></div>
    <div class="content tasklist table_box">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th>被通知用户</th>
                <th>通知内容</th>
                <th>查看链接</th>
                <th>发送时间</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
                {foreach $list as $item} 
                <tr>
                    <!-- <td><label for="name"> <input type="checkbox" name="userid" value="{$item.userinfo.userid}">{$item.userinfo.nickname}<span style="fonts-size:12px">({$item.userinfo.username})</span></label></td> -->
                    <td><input type="checkbox" name="userid" value="{$item.id}">{$item.userinfo.nickname}<span style="font-size:12px">({$item.userinfo.username})</span></td>
                    <td>{$item.content}</td>
                    <td>{$item.href_url}</td>
                    <td>{$item.create_time}</td>
                    <td>{$item.status_txt}</td>
                    <td>
                        {eq name = '$item.status' value= "0"}
                        <a href="#" class="btn btn-success isupdate" ids = '{$item.id}' >设置为已读</a>
                        {/eq}
                        <a href="#" class="btn btn-primary isdelete" data-url="{:url('isDelete', ['id' => $item.id])}">删除</a>
                    </td>
                </tr>
                {/foreach}
        
                {eq name = '_empty' value = '1'}
                    <tr><td colspan="6">暂时没有数据.....</td></tr>
                {/eq}
                <tr>
                    <td colspan="6">
                        <button class="btn btn-success selectAll">全选</button>
                        <button class="btn btn-success over">反选</button>
                        <button class="btn btn-success cancleAll">清除选中</button>
                        <button class="btn btn-success check-choice">确认删除</button>
                    </td>
                </tr>
            </tbody>
        </table>
        {$page}
    </div>
</div>

<script>
  $(function () {
    $(".check-choice").click(function(){
        var ids = '';
        $("[name='userid']:checked").each(function(){
            ids+= $(this).val() + ',';
        })
        ids = ids.substring(0, ids.length-1);
        var href = "{:url('isDelete')}";
        location.href = href + "?ids="+ids;
    })
    $(".selectAll").click(function(){ 
        $("[name='userid']").prop("checked",true); 
    }) 
    $(".cancleAll").click(function(){ 
        $("[name='userid']").prop("checked",false); 
    })

    $(".over").click(function(){ 
        $("[name='userid']").each(function(){ 
            if($(this).is(":checked")){ 
                $(this).prop("checked",false); 
            }else{ 
                $(this).prop("checked",true); 
            } 
        }) 
    }) 

    $('.isdelete').click(function () {
      var _url = $(this).data("url");
      $.modal.confirm('你是否确定删除', function () {
        location.href = _url;
      });
    });
    $(".isupdate").click(function(){
        var _this = $(this);
        var ids = _this.attr('ids');
        if(ids == 'all'){
            var model = $.modal.confirm('你是否确定全部设置成已读', function () {
                updateStatus(ids, $(".isupdate"));
                model.close();
            })
        }else{
            updateStatus(ids, _this);
        }
        
    })

    function updateStatus(ids, _this)
    {
        $.get('{:url("admin/Inform/isUpdate")}?id=' + ids,function(res){
            $.modal.alert(res.msg);
            if(!res.err) _this.hide()
        })
    }

    $('#begintime,#endtime').datetimepicker({
      language: 'zh-CN',
      weekStart: 1,
      todayBtn: 1,
      autoclose: 1,
      todayHighlight: 1,
      startView: 2,
			endDate : new Date(),
      minView: 2,
      forceParse: 0
    });
    $('#begintime').on('changeDate',function(e){  
        var startTime = e.date;  
        $('#endtime').datetimepicker('setStartDate',startTime);  
    });
    $('#endtime').on('changeDate',function(e){  
        var startTime = e.date;  
        $('#begintime').datetimepicker('setStartDate',startTime);  
    });
  })
</script>
{include file='common/foot' /}