{include file='web@common/link'/}
<link rel="stylesheet" type="text/css"  href="/static/vipweb/css/user.css">
<script src="/static/vipweb/vue-component/page-nation.js"></script>
<style>
    body{
        overflow-y: auto;
    }
    .el-input{
        width: auto;
    }
    .el-input__inner{
        margin-right: 3px;
    }
    .options .el-input__inner{
        width: 100px;
    }
</style>
<div id="app" v-cloak>
    <el-card class="box-card">
        <div slot="header" class="clearfix">
            <span class="title">兑换明细</span>
        </div>
        <el-radio-group v-model="label" size="small">
            <el-radio-button @click.native="link('{:url('detail')}')" label="账户明细"></el-radio-button>
            <el-radio-button @click.native="link('{:url('drecharge')}')" label="充值明细"></el-radio-button>
            <el-radio-button @click.native="link('{:url('dexchange')}')" label="兑换明细"></el-radio-button>
            <el-radio-button @click.native="link('{:url('dtransform')}')" label="转账明细" v-if="{$company['game_status']}"></el-radio-button>
        </el-radio-group>
        <exchange-detail></exchange-detail>
    </el-card>
</div>
<!--钻石明细-->
<template id="exchangeDetail">
    <div>
        <div class="options">
            <el-select
                    size="mini"
                    v-model="status"
                    placeholder="请选择订单状态">
                <el-option
                        v-for="item in statusOptions"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                </el-option>
            </el-select>
            <el-select
                    @change="search()"
                    size="mini"
                    v-model="time"
                    placeholder="请选择时间">
                <el-option
                        v-for="item in options"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                </el-option>
            </el-select>
            <el-date-picker v-if="!time" style="width:270px"
                            v-model="value"
                            type="daterange"
                            size="mini"
                            format="yyyy 年 MM 月 dd 日"
                            value-format="yyyy-MM-dd"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期"
                            :picker-options="pickerOptions0">
            </el-date-picker>
        </div>
        <page-nation :url="url" @game-record="sortC" v-if="refresh">
            <el-table-column property="id" label="ID" width="90" sortable="custom"></el-table-column>
            <el-table-column property="time" label="兑换时间" width="150" sortable="custom">
                <template slot-scope="scope">{{scope.row.create_time}}</template>
            </el-table-column>
            <el-table-column property="name" label="兑换内容"  width="130"></el-table-column>
            <el-table-column property="num" label="兑换数量"  width="100"></el-table-column>
            <el-table-column property="money" label="消耗{$company['lottery_unit']}" width="140" sortable="custom"></el-table-column>
            <el-table-column property="status" label="状态" width="100">
                <template slot-scope="scope">
                    <em v-html="scope.row.status"></em>
                </template>
            </el-table-column>
            <el-table-column property="status" label="备注">
                <template slot-scope="scope">
                    <em v-html="scope.row.admin_remark"></em>
                </template>
            </el-table-column>
            <el-table-column property="status" label="操作" width="80">
                <template slot-scope="scope">
                    <el-button type="danger" plain size="mini" v-if="!scope.row.status_code" @click.native="returnChange(scope.row.id)">撤单</el-button>
                    <span v-else>--</span>
                </template>
            </el-table-column>
        </page-nation>
    </div>
</template>

{include file='web@common/end'/}
<script>
    'use strict';

    $(function () {
        var id = GetUrlParam('userid');
        //钻石明细
        Vue.component('exchange-detail', {
            template: '#exchangeDetail',
            data: function data() {
                return {
                    intUrl: '{:url("details/exchangeList")}'+ '?userid=' + id,
                    options: [//快捷时间选项
                        { value: 7, label: '最近一周' },
                        { value: 30, label: '最近一个月' },
                        { value: 90, label: '最近三个月' },
                        { value: 180, label: '最近六个月' },
                        { value: 0, label: '自定义时间' }],
                    statusOptions: [//订单状态类型选项
                        { value: '', label: '全部订单状态' },
                        { value: '0', label: '未处理' },
                        { value: '1', label: '已处理' },
                        { value: '7', label: '系统撤单' }],
                    status: '',
                    time: '', //快捷时间值
                    timeTemp: '',
                    value: '', //自定义时间值
                    sort: '', //排序
                    refresh: true,

                    //设置选择今天之前的日期
                    pickerOptions0: {
                        disabledDate: function disabledDate(time) {
                            return time.getTime() > Date.now();
                        }
                    }
                };
            },

            computed: {
                timeValue: function timeValue() {
                    if (!this.time == 0) {
                        this.timeTemp = this.time;
                    }
                    var day = parseInt(this.timeTemp);
                    return timeArr(day);
                },
                url: function url() {
                    var sort, status;
                    if (this.sort.length) {
                        sort = this.sort;
                    } else {
                        sort = '';
                    }
                    if (this.status.length) {
                        status = '&status=' + this.status;
                    } else {
                        status = '';
                    }
                    if (this.value.length) {
                        return this.intUrl + '&starttime=' + this.value[0] + '&endtime=' + this.value[1] + sort + status;
                    } else {
                        return this.intUrl + '&starttime=' + this.timeValue[0] + '&endtime=' + this.timeValue[1] + sort + status;
                    }
                }
            },
            methods: {
                //搜索条件
                search: function search() {
                    if (!this.time == 0) {
                        //自定义时间切换为快捷时间选择
                        this.value = '';
                    }
                },
                sortC: function sortC(val) {
                    if (val.prop == null) {
                        this.sort = '';
                    } else {
                        var s;
                        if (val.order == 'descending') {
                            s = 2; //降序
                        } else {
                            s = 1; //升序
                        }
                        this.sort = '&sort' + val.prop + '=' + s;
                    }
                },

                //搜索
                doSearch: function doSearch() {
                    this.trade = this.tradeOptions[0].value;
                    this.sz = this.szOptions[0].value;
                    this.idWords = this.id;
                    this.remarkWords = this.remark;
                },
                //撤销订单
                returnChange:function (id) {
                    var _this = this
                    _this.$confirm('确定要撤销该订单吗?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        lockScroll: false
                    }).then(function(){
                        $.get('{:url("returnChange")}', {
                            id:id,
                        }, function (res) {
                            if(!res.err){
                                _this.$alert(res.msg, '提示', {
                                    confirmButtonText: '确定',
                                    center: true,
                                    type: 'success',
                                    lockScroll: false,
                                    callback: function(action){
                                        _this.refresh = false
                                        _this.$nextTick(function () {
                                            _this.refresh = true
                                        })
                                    }
                                })
                            }else {
                                _this.$alert(res.msg, '提示', {
                                    confirmButtonText: '确定',
                                    center: true,
                                    type: 'error',
                                    lockScroll: false
                                });
                            }
                        });
                    }).catch(function(){
                    });
                }
            },
            created: function created() {
                this.time = this.options[0].value;
            }
        });

        new Vue({
            el: "#app",
            data: {
                label: '兑换明细'
            },
            methods: {
                link: function link(url) {
                    window.location.href = url + '?userid=' + id;;
                }
            }
        });
    });
</script>