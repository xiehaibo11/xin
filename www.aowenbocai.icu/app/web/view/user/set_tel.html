{include file='web@common/login_head' title='手机管理'/}
<link rel="stylesheet" type="text/css"  href="/static/vipweb/css/user.css">
<style>
    .form{
        width: 430px;
    }
    html {min-width: 1200px;}
</style>
<div class="border-top">
    <div id="app" class="web" v-cloak>
        <el-card class="box-card">
            <div slot="header" class="clearfix">
                <el-breadcrumb>
                    <el-breadcrumb-item>手机管理</el-breadcrumb-item>
                    <el-breadcrumb-item v-if="!{$data.tel.islock}">绑定手机</el-breadcrumb-item>
                    <el-breadcrumb-item v-else>修改手机</el-breadcrumb-item>
                </el-breadcrumb>
            </div>
            <template v-if="!{$data.tel.islock}">
                <bind-tel :is-yzm="isYzm" style="width: 36%;margin: 10px auto"></bind-tel>
            </template>
            <template v-else>
                <change-tel :is-yzm="isYzm" :is-email="isEmail" style="width: 50%;margin: 10px auto"></change-tel>
            </template>
        </el-card>
    </div>
</div>

<!--绑定手机-->
<template id="bindTel">
    <el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="100px" class="ruleForm form login">
        <el-form-item prop="tel"  label="手机号">
            <el-input v-model="ruleForm.tel" type="tel" placeholder="请输入手机号"></el-input>
        </el-form-item>
        <el-form-item prop="yzm"  label="验证码" v-if="isYzm" error>
            <el-input v-model.number="ruleForm.yzm" type="tel" class="yzm" placeholder="请输入验证码 "></el-input>
            <el-button type="primary" plain @click.native="sendsms" class="btn-yzm" v-if="smsState">{{text}}</el-button>
            <el-button type="info" class="btn-yzm" plain disabled v-else>{{text}}</el-button>
        </el-form-item>
        <el-form-item>
            <el-button  type="danger" @click="submitForm('ruleForm')" :loading="loading">绑定</el-button>
        </el-form-item>
    </el-form>
</template>

<!--更改手机-->
<template id="changeTel">
    <div>
        <div class="l-concise-hd"  v-if="isYzm || isEmail">
            <div class="steps steps-2">
                <ol>
                    <li :class="{'active' : steps1}"><span><i>1</i>安全验证</span></li>
                    <li :class="{'active' : steps2}"><span><i>2</i>重置手机号</span></li>
                </ol>
            </div>
        </div>
        <template v-if="steps1">
            <change-tel-steps1 @yz-suc="changeStep" :is-yzm="isYzm" :is-email="isEmail"></change-tel-steps1>
        </template>
        <template v-if="steps2">
            <change-tel-steps2 :is-yzm="isYzm"></change-tel-steps2>
        </template>
    </div>
</template>

<!--更改手机 ****安全验证-->
<template id="changeTelSteps1">
    <div>
        <!--手机短信验证-->
        <el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="100px" class="ruleForm form login"  v-if="isYzm && checkWay==1">
            <div class="tr" style="margin-bottom: 15px;font-size: 13px;height: 28px" v-if="isEmail">原手机接收不了短信？
                <a class="link" style="font-size: 13px" @click="checkEmail">使用已绑定邮箱进行验证</a>
            </div>
            <el-form-item  prop="showTel" label="原手机号">
                <el-input v-model="ruleForm.showTel" type="tel" placeholder="请输入手机号" disabled></el-input>
            </el-form-item>
            <el-form-item prop="yzm"  label="验证码">
                <el-input v-model.number="ruleForm.yzm" type="tel" class="yzm" placeholder="请输入验证码 "></el-input>
                <el-button type="primary" plain @click.native="sendsms" class="btn-yzm" v-if="smsState">{{text}}</el-button>
                <el-button type="info" class="btn-yzm" plain disabled v-else>{{text}}</el-button>
            </el-form-item>
            <el-form-item>
                <el-button  type="danger" @click="checkYzm('ruleForm',1)">下一步</el-button>
            </el-form-item>
        </el-form>
        <!--邮箱验证-->
        <el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm2" label-width="100px" class="ruleForm form login" v-if="isEmail && checkWay==2">
            <div class="tr" style="margin-bottom: 15px;font-size: 13px;height: 28px" v-if="isYzm">
                <a class="link" style="font-size: 13px"  @click="checkWay=1">使用已绑定手机进行验证</a>
            </div>
            <el-form-item  prop="email" label="已绑定邮箱">
                <el-input v-model="ruleForm.email" type="text" placeholder="请已绑定邮箱" disabled></el-input>
            </el-form-item>
            <el-form-item prop="emailYzm"  label="验证码">
                <el-input v-model.number="ruleForm.emailYzm" type="tel" class="yzm" placeholder="请输入验证码"></el-input>
                <el-button type="primary" plain @click.native="sendEmail" class="btn-yzm" v-if="smsState2" :loading="loadingEmail">{{text2}}</el-button>
                <el-button type="info" class="btn-yzm" plain disabled v-else>{{text2}}</el-button>
            </el-form-item>
            <el-form-item>
                <el-button  type="danger" @click="checkYzm('ruleForm2',2)">下一步</el-button>
            </el-form-item>
        </el-form>
    </div>
</template>

<!--更改手机 ****重置手机-->
<template id="changeTelSteps2">
    <el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="100px" class="ruleForm form login">
        <el-form-item prop="tel" label="新手机号">
            <el-input v-model="ruleForm.tel" type="tel" placeholder="请输入新的手机号"></el-input>
        </el-form-item>
        <el-form-item prop="yzm" label="验证码" v-if="isYzm">
            <el-input v-model.number="ruleForm.yzm" type="tel" class="yzm" placeholder="请输入验证码 "></el-input>
            <el-button class="btn-yzm" type="primary" plain @click.native="sendsms" v-if="smsState">{{text}}</el-button>
            <el-button class="btn-yzm" type="info" plain disabled v-else>{{text}}</el-button>
        </el-form-item>
        <el-form-item>
            <el-button  type="danger" @click="submitForm('ruleForm')" :loading="loading">确认重置</el-button>
        </el-form-item>
    </el-form>
</template>

{include file='web@common/foot' /}
<script>
    'use strict';

    $(function () {
        //更改手机***重置手机
        Vue.component('change-tel-steps2', {
            template: '#changeTelSteps2',
            props: ['isYzm'],
            data: function data() {
                return {
                    ruleForm: {
                        tel: '',
                        yzm: ''
                    },
                    rules: {
                        tel: [{ required: true, message: '手机号不能为空', trigger: 'blur' }, { pattern: /^1[3-9]{1}[0-9]{9}$/, message: '请输入正确的手机号', trigger: 'blur' }],
                        yzm: [{ required: true, message: '请输入验证码', trigger: 'blur' }]
                    },
                    loading: false,
                    text: '获取验证码',
                    smsState: true,
                    countDown: 120
                };
            },

            methods: {
                //发送验证码
                sendsms: function sendsms() {
                    var _this = this;

                    if (this.countDown != 120) return false;
                    var reg = /^1[3-9]{1}[0-9]{9}$/;
                    var res = reg.test(this.ruleForm.tel);
                    if (!res) {
                        this.$message({
                            showClose: true,
                            message: '手机号格式不正确，请输入正确的手机号',
                            type: 'error'
                        });
                        return false;
                    }
                    $.get('/index/user/sendSmsChange', {
                        tel: this.ruleForm.tel
                    }, function (res) {
                        if (!res.err) {
                            _this.smsState = false;
                            _this.text = "已发送(" + _this.countDown + "秒)";
                            var interval = setInterval(function () {
                                _this.countDown = _this.countDown - 1;
                                if (_this.countDown == 0) {
                                    _this.text = '获取验证码';
                                    _this.countDown = 120;
                                    clearInterval(interval);
                                    _this.smsState = true;
                                    return;
                                }
                                _this.text = "已发送(" + _this.countDown + "秒)";
                            }, 1000);
                        } else {
                            _this.$message({
                                showClose: true,
                                message: res.msg,
                                type: 'error'
                            });
                        }
                    });
                },
                submitForm: function submitForm(formName) {
                    var _this2 = this;

                    this.$refs[formName].validate(function (valid) {
                        if (valid) {
                            _this2.loading = true;
                            var data = {
                                tel: _this2.ruleForm.tel,
                            };
                            if(_this2.isYzm){
                                data['yzm']= _this2.ruleForm.yzm
                            }
                            $.post('/index/user/writePhone', data, function (res) {
                                if (!res.err) {
                                    _this2.loading = false;
                                    _this2.$message({
                                        showClose: true,
                                        message: res.msg,
                                        type: 'success'
                                    });
                                    setTimeout(function () {
                                        location.href = "{:url('user/my')}?ac=0-2";
                                    }, 1500);
                                    return;
                                }
                                _this2.loading = false;
                                _this2.$message({
                                    showClose: true,
                                    message: res.msg,
                                    type: 'error'
                                });
                            });
                        } else {
                            console.log('error submit!!');
                            return false;
                        }
                    });
                }
            }
        });
        //更改手机***安全验证
        Vue.component('change-tel-steps1', {
            template: '#changeTelSteps1',
            props: ['isYzm', 'isEmail'],
            data: function data() {
                return {
                    ruleForm: {
                        showTel: '{$data.tel.number}',
                        tel: '{$user.tel}',
                        yzm: '',
                        email: "{$user.email|substr_replace=###,'****',2,6}",
                        emailYzm: ''
                    },
                    rules: {
                        yzm: [{ required: true, message: '请输入验证码', trigger: 'blur' }],
                        emailYzm: [{ required: true, message: '请输入验证码', trigger: 'blur' }]
                    },
                    checkWay: this.isYzm ? 1 : 2, //选择验证方式
                    text: '获取验证码',
                    smsState: true,
                    countDown: 120,
                    text2: '获取验证码',
                    smsState2: true,
                    countDown2: 120,
                    loadingEmail: false
                };
            },

            methods: {
                //发送手机短信验证码
                sendsms: function sendsms() {
                    var _this3 = this;

                    if (this.countDown != 120) return false;
                    $.get('/index/user/sendSmsEdit', function (res) {
                        if (!res.err) {
                            _this3.smsState = false;
                            _this3.text = "已发送(" + _this3.countDown + "秒)";
                            var interval = setInterval(function () {
                                _this3.countDown = _this3.countDown - 1;
                                if (_this3.countDown == 0) {
                                    _this3.text = '获取验证码';
                                    _this3.countDown = 120;
                                    clearInterval(interval);
                                    _this3.smsState = true;
                                    return;
                                }
                                _this3.text = "已发送(" + _this3.countDown + "秒)";
                            }, 1000);
                        } else {
                            _this3.$message({
                                showClose: true,
                                message: res.msg,
                                type: 'error'
                            });
                        }
                    });
                },

                //验证是否绑定邮箱
                checkEmail: function checkEmail() {
                    if (!parseInt('{$data.email.islock}')) {
                        this.$confirm('您还未绑定邮箱！', '提示', {
                            confirmButtonText: '立即去绑定',
                            cancelButtonText: '取消',
                            type: 'warning',
                            lockScroll: false
                        }).then(function () {
                            window.location.href = '{:url("setEmail")}';
                        }).catch(function () {});
                    } else {
                        this.checkWay = 2;
                    }
                },

                //发送邮箱验证码
                sendEmail: function sendEmail() {
                    var _this4 = this;

                    this.loadingEmail = true;
                    if (this.countDown2 != 120) return false;
                    $.get('{:url("sendTelEmail")}', function (res) {
                        if (!res.err) {
                            _this4.smsState2 = false;
                            _this4.text2 = "已发送(" + _this4.countDown2 + "秒)";
                            _this4.loadingEmail = false;
                            var interval = setInterval(function () {
                                _this4.countDown2 = _this4.countDown2 - 1;
                                if (_this4.countDown2 == 0) {
                                    _this4.text2 = '获取验证码';
                                    _this4.countDown2 = 120;
                                    clearInterval(interval);
                                    _this4.smsState2 = true;
                                    return;
                                }
                                _this4.text2 = "已发送(" + _this4.countDown2 + "秒)";
                            }, 1000);
                        } else {
                            _this4.$message({
                                showClose: true,
                                message: res.msg,
                                type: 'error'
                            });
                            _this4.loadingEmail = false;
                        }
                    });
                },

                //邮箱验证码是否正确
                checkYzm: function checkYzm(formName, changeWay) {
                    var _this5 = this;

                    this.$refs[formName].validate(function (valid) {
                        if (valid) {
                            var yzm = changeWay == 1 ? _this5.ruleForm.yzm : _this5.ruleForm.emailYzm;
                            $.post('{:url("checkTelEmail")}', {
                                changeWay: changeWay,
                                yzm: yzm
                            }, function (res) {
                                if (!res.err) {
                                    _this5.$emit('yz-suc');
                                    return;
                                }
                                _this5.$message({
                                    showClose: true,
                                    message: res.msg,
                                    type: 'error'
                                });
                            });
                        } else {
                            console.log('error submit!!');
                            return false;
                        }
                    });
                }
            }
        });
        //更改手机
        Vue.component('change-tel', {
            template: '#changeTel',
            props: ['isYzm', 'isEmail'],
            data: function data() {
                return {
                    steps1: this.isYzm || this.isEmail ? 1 : 0,
                    steps2: !this.isYzm && !this.isEmail ? 1 : 0
                };
            },

            methods: {
                changeStep: function changeStep() {
                    //改变步骤
                    this.steps1 = 0;
                    this.steps2 = 1;
                }
            }
        });
        //绑定手机
        Vue.component('bind-tel', {
            template: '#bindTel',
            props: ['isYzm'],
            data: function data() {
                return {
                    ruleForm: {
                        tel: '',
                        yzm: ''
                    },
                    rules: {
                        tel: [{ required: true, message: '手机号不能为空', trigger: 'blur' }, { pattern: /^1[3-9]{1}[0-9]{9}$/, message: '请输入正确的手机号', trigger: 'blur' }],
                        yzm: [{ required: true, message: '请输入验证码', trigger: 'blur' }]
                    },
                    text: '获取验证码',
                    smsState: true,
                    countDown: 120,
                    loading: false
                };
            },

            methods: {
                //发送验证码
                sendsms: function sendsms() {
                    var _this6 = this;

                    if (this.countDown != 120) return false;
                    var reg = /^1[3-9]{1}[0-9]{9}$/;
                    var res = reg.test(this.ruleForm.tel);
                    if (!res) {
                        this.$message({
                            showClose: true,
                            message: '手机号格式不正确，请输入正确的手机号',
                            type: 'error'
                        });
                        return false;
                    }
                    $.get('/index/user/sendSms', {
                        tel: this.ruleForm.tel
                    }, function (res) {
                        if (!res.err) {
                            _this6.smsState = false;
                            _this6.text = "已发送(" + _this6.countDown + "秒)";
                            var interval = setInterval(function () {
                                _this6.countDown = _this6.countDown - 1;
                                if (_this6.countDown == 0) {
                                    _this6.text = '获取验证码';
                                    _this6.countDown = 120;
                                    clearInterval(interval);
                                    _this6.smsState = true;
                                    return;
                                }
                                _this6.text = "已发送(" + _this6.countDown + "秒)";
                            }, 1000);
                        } else {
                            _this6.$message({
                                showClose: true,
                                message: res.msg,
                                type: 'error'
                            });
                        }
                    });
                },
                submitForm: function submitForm(formName) {
                    var _this7 = this;

                    this.$refs[formName].validate(function (valid) {
                        if (valid) {
                            _this7.loading = true;
                            var data;
                            if (_this7.isYzm) {
                                data = {
                                    tel: _this7.ruleForm.tel,
                                    yzm: _this7.ruleForm.yzm
                                };
                            } else {
                                data = {
                                    tel: _this7.ruleForm.tel
                                };
                            }
                            $.get('/index/User/lockTel', data, function (res) {
                                if (!res.err) {
                                    _this7.loading = false;
                                    _this7.$message({
                                        showClose: true,
                                        message: res.msg,
                                        type: 'success'
                                    });
                                    setTimeout(function () {
                                        location.href = "{:url('user/my')}?ac=0-2";
                                    }, 1500);
                                    return;
                                }
                                _this7.loading = false;
                                _this7.$message({
                                    showClose: true,
                                    message: res.msg,
                                    type: 'error'
                                });
                            });
                        } else {
                            console.log('error submit!!');
                            return false;
                        }
                    });
                }
            }
        });

        new Vue({
            el: "#app",
            data: {
                isYzm: parseInt('{$data.tel.isOpen}'), //是否开启短信接口
                isEmail: parseInt('{$data.email.isOpen}') //是否开启邮箱验证
            }
        });
    });
</script>