{include file='web@common/link'/}
<link rel="stylesheet" type="text/css"  href="/static/vipweb/css/user.css">
<script src="/static/vipweb/vue-component/page-nation.js"></script>
<style>
    body{ overflow-y: auto;}
    .el-input{
        width: auto;
    }
    .el-input__inner {
        margin-right: 3px;
    }
    .options .el-input__inner {
        width: 170px;
    }
</style>
<div id="app" v-cloak>
    <el-card class="box-card">
        <div slot="header" class="clearfix">
            <span class="title">投注记录</span>
        </div>
        <!--搜索条件-->
        <div class="options flex-box">
            <el-select @change="search()" size="mini" v-model="gameid" placeholder="请选择彩种">
                <el-option v-for="item in gameOptions" :key="item.value" :label="item.label" :value="item.value" @click.native="getName(item.label,item.value)"></el-option>
            </el-select>
            <el-select @change="search()" size="mini" v-model="time" placeholder="请选择时间">
                <el-option v-for="item in options" :key="item.value" :label="item.label" :value="item.value"></el-option>
            </el-select>
            <!--购买方式-->
            <el-select @change="search()" size="mini" v-model="order" placeholder="请选择购买方式">
                <template v-if="Number({$company['join_isOpen']})">
                    <el-option  v-for="(item,index) in orderOptions" :key="item.value" :label="item.label" :value="item.value"></el-option>
                </template>
                <template v-else>
                    <el-option  v-for="(item,index) in orderOptions" :key="item.value" :label="item.label" :value="item.value" v-if="index<3"></el-option>
                </template>
            </el-select>
            <!--方案状态-->
            <el-select @change="search()" size="mini" v-model="status" placeholder="方案状态">
                <el-option v-for="item in statusOptions" :key="item.value" :label="item.label" :value="item.value"></el-option>
            </el-select>
            <div class="flex tr">
                <el-input v-model="lotteryId" type="text" size="mini" placeholder="方案编号查询" prefix-icon="el-icon-search"></el-input>
                <el-button plain size="mini" type="info" @click.native="idSearch">搜索</el-button>
            </div>
        </div>
        <div v-if="!time" class="bg" style="padding: 0px 90px 10px;">
            <el-date-picker v-model="value"  style="width:270px"
                            type="daterange"
                            size="mini"
                            format="yyyy 年 MM 月 dd 日"
                            value-format="yyyy-MM-dd"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期"
                            :picker-options="pickerOptions0">
            </el-date-picker>
        </div>
        <!--搜索条件 end-->
        <div>
            <game-fl-record :url="url" :game-name="gameName" @sort-change="sortChange"></game-fl-record>
        </div>
    </el-card>
</div>
<!--//分类彩种-->
<template id="gameFlRecord" key="fl">
    <div>
        <page-nation :url="url"  @game-record="sortC" v-if="refresh">
            <el-table-column prop="BuyInfo.lottery_id" label="方案编号"  width="175"></el-table-column>
            <el-table-column prop="ext_txt" label="彩种" width="100"></el-table-column>
            <el-table-column prop="BuyInfo.expect" label="期号"></el-table-column>
            <el-table-column label="合买" width="50">
                <template slot-scope="scope">
                    <span :class="{'red': scope.row.BuyInfo.is_join}">{{scope.row.BuyInfo.is_join ? '是' : '否'}}</span>
                </template>
            </el-table-column>
            <el-table-column prop="money" label="投注金额" width="98" sortable="custom">
                <template slot-scope="scope">
                    <span>{{scope.row.money}}{$system.lottery_unit}</span>
                </template>
            </el-table-column>
            <el-table-column label="方案状态" width="80">
                <template slot-scope="scope">
                    <span v-if="scope.row.BuyInfo.statusCode == 0">
                        <template v-if="scope.row.BuyInfo.is_join">
                             <em v-if="!scope.row.BuyInfo.finsh">合买中</em>
                             <em v-else>未出票</em>
                        </template>
                        <template v-else>
                            未出票
                        </template>
                    </span>
                    <span v-if="scope.row.BuyInfo.statusCode == 1" class="green">等待开奖</span>
                    <span v-if="scope.row.BuyInfo.statusCode == 2 && scope.row.bonus > 0" class="red">已中奖</span>
                    <span v-if="scope.row.BuyInfo.statusCode == 2 && scope.row.bonus == 0" class="c-3">未中奖</span>
                    <span v-if="scope.row.BuyInfo.statusCode == 6" class="c-3">流产撤单</span>
                    <span v-if="scope.row.BuyInfo.statusCode == 7" class="c-3">系统撤单</span>
                    <span v-if="scope.row.BuyInfo.statusCode == 8" class="c-3">用户撤单</span>
                </template>
            </el-table-column>
            <el-table-column prop="bonus" label="奖金" sortable="custom" width="92">
                <template slot-scope="scope">
                    <span><em :class="{'red':scope.row.bonus > 0}">{{scope.row.bonus}}</em>{$system.lottery_unit}</span>
                </template>
            </el-table-column>
            <el-table-column prop="create_time" label="投注时间" width="110" sortable="custom">
                <template slot-scope="scope">
                    <span>{{scope.row.create_time | timeSplit}}</span>
                </template>
            </el-table-column>
            <el-table-column label="操作" width="85">
                <template slot-scope="scope">
                    <div class="flex-box">
                        <el-button type="text" size="mini" @click.native="toDetail(scope.row.buy_id,scope.row.BuyInfo.lottery_id)">详情</el-button>
                        <el-button type="text" size="mini" @click.native="cancelOrder(scope.row.BuyInfo.lottery_id)" v-if="scope.row.BuyInfo.statusCode <= 1 && !scope.row.BuyInfo.is_join">撤单</el-button>
                    </div>
                </template>
            </el-table-column>
        </page-nation>
    </div>
</template>
{include file='web@common/end'/}

<script>
    'use strict';

    $(function () {
        var id = GetUrlParam('userid');
        //分类彩种记录
        Vue.component('game-fl-record', {
            template: '#gameFlRecord',
            props: ['url', 'gameName'],
            data: function() {
                return {
                    sort: '',
                    refresh:true
                };
            },
            filters:{
                timeSplit:function (val) {
                    return val.toString().slice(5)
                }
            },
            methods: {
                toDetail: function (id, orderid) {
                    var u = '?lottery_id=' + orderid + '&id=' + id;
                    window.open('{:url("./orders")}' + u);
                },
                sortC: function (val) {
                    if (val.prop == null) {
                        this.sort = '';
                    } else {
                        var s;
                        if (val.order == 'descending') {
                            s = 0; //降序
                        } else {
                            s = 1; //升序
                        }
                        this.sort = '&type=' + val.prop + '&sort=' + s;
                    }
                    this.$emit('sort-change', this.sort);
                },
                //撤销订单
                cancelOrder:function (id) {
                    var _this = this
                    _this.$confirm('确定要撤销该订单吗?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        lockScroll: false
                    }).then(function(){
                        $.get('{:url("orders/returnTicket")}', {
                            lottery_id:id,
                        }, function (res) {
                            if(!res.err){
                                _this.$alert(res.msg, '提示', {
                                    confirmButtonText: '确定',
                                    center: true,
                                    type: 'success',
                                    lockScroll: false,
                                    callback: function(action){
                                        _this.refresh = false
                                        _this.$nextTick(function () {
                                            _this.refresh = true
                                        })
                                    }
                                })
                            }else {
                                _this.$alert(res.msg, '提示', {
                                    confirmButtonText: '确定',
                                    center: true,
                                    type: 'error',
                                    lockScroll: false
                                });
                            }
                        });
                    }).catch(function(){
                    });
                }
            }
        });
        new Vue({
            el: "#app",
            data: {
                intUrl: '{:url("Details/games")}?userid='+ id+ '&gameid=', //分类彩种
                urlType: '', //游戏type
                gameName: '', //游戏名
                options: [//时间选项
                    { value: 7, label: '最近一周' },
                    { value: 30, label: '最近一个月' },
                    { value: 90, label: '最近三个月' },
                    { value: 180, label: '最近六个月' },
                    { value: 0, label: '自定义时间' }],
                gameOptions: {$lotteryInfo }, //彩种选项 value为空时为全部彩种
                orderOptions: [
                    { value: '', label: '所有订单' },
                    { value: '0', label: '自购' },
                    { value: '3', label: '追号' },
                    { value: '1', label: '发起合买' },
                    { value: '2', label: '参与合买' }] , //购买方式
                statusOptions: "{$company['join_isOpen']}" == 1 ? [
                    { value: '', label: '所有方案状态' },
                    { value: '311', label: '合买中' },
                    { value: '0', label: '等待开奖' },
                    { value: '1', label: '已中奖' },
                    { value: '2', label: '未中奖' },
                    { value: '6', label: '流产撤单' },
                    { value: '8', label: '用户撤单' },
                    { value: '7', label: '系统撤单' }] : [
                    { value: '', label: '所有方案状态' },
                    { value: '0', label: '等待开奖' },
                    { value: '1', label: '已中奖' },
                    { value: '2', label: '未中奖' },
                    { value: '8', label: '用户撤单' },
                    { value: '7', label: '系统撤单' }], //方案状态选项
                checkStatus: [],
                time: '', //快捷时间值
                timeTemp: '',
                gameid: '', //游戏id
                value: '', //自定义时间值
                order: '', //订单选项
                status: '', //方案状态
                lotteryId: '', //方案编号
                searchId: '',
                sort: '', //排序条件

                //设置选择六个月之前到今天的日期
                pickerOptions0: {
                    disabledDate: function (time) {
                        var curDate = new Date().getTime();
                        var three = 180 * 24 * 3600 * 1000;
                        var threeMonths = curDate - three;
                        return time.getTime() > Date.now() || time.getTime() < threeMonths;;
                    }
                }
            },
            computed: {
                timeValue: function() {
                    if (!this.time == 0) {
                        this.timeTemp = this.time;
                    }
                    var day = parseInt(this.timeTemp);
                    return timeArr(day);
                },
                url: function() {
                    var id, buytype, status, sort; //方案编号，购买方式，方案状态，排序条件
                    buytype = this.order.length ?  '&join=' + this.order : ''
                    status = this.status.length ? '&bounsStatus=' + this.status : ''
                    sort = this.sort ? this.sort : ''
                    id = this.searchId.length ? '&lottery_id=' + this.searchId : ''
                    if (this.value.length) {
                        return this.intUrl + this.gameid + '&starttime=' + this.value[0] + '&endtime=' + this.value[1] + buytype + status + sort + id;
                    } else {
                        return this.intUrl + this.gameid + '&starttime=' + this.timeValue[0] + '&endtime=' + this.timeValue[1] + buytype + status + sort + id;
                    }
                }
            },
            methods: {
                //搜索条件
                search: function search() {
                    if (!this.time == 0) {
                        //自定义时间切换为快捷时间选择
                        this.value = '';
                    }
                    this.lotteryId = ''; //清空方案号查询条件
                    this.searchId = ''; //清空方案号查询条件
                },
                getName: function (name, gameid) {
                    var _this = this;
                    this.urlType = gameid;
                    setTimeout(function () {
                        _this.gameName = name;
                    }, 200);
                    this.sort = ''; //彩种切换时清空排序条件
                },

                //排序条件
                sortChange: function (val) {
                    this.sort = val;
                },

                //方案编号查询
                idSearch: function () {
                    this.searchId = this.lotteryId;
                }
            },
            created: function () {
                this.time = this.options[0].value;
                this.gameid = this.gameOptions[0].value;
                this.order = this.orderOptions[0].value;
                this.status = this.statusOptions[0].value;
            }
        });
    });
</script>