{include file='web@common/login_head' title="用户注册"/}
<link rel="stylesheet" href="/static/vipweb/css/login.css">
<style type="text/css">
    .el-dialog--center .el-dialog__body{
        padding: 10px 20px;
    }
</style>
<div id="app" style=" border-top: 2px solid #de3031;min-height: 400px" :style="{'height':wHeight + 'px'}">
    <div class="page-reg">
        <tel-reg></tel-reg>
        <div class="tr link">
            <a href="">已有账号？</a>
            <a href="{:url('./login')}" class="link">去登录</a>
        </div>
    </div>
</div>
<template id="telReg">
    <div class="reg-form">
        <el-form :model="ruleForm" status-icon :rules="rules" ref="ruleForm" label-width="100px" label-position="right">
            <el-form-item prop="code" label="邀请码" v-if="isCode">
                <template v-if="'{$code}'.length">
                    <el-input type="text" v-model="ruleForm.code" disabled auto-complete="off" placeholder="请输入邀请码"></el-input>
                </template>
                <template v-else>
                    <el-input type="text" v-model="ruleForm.code" auto-complete="off" placeholder="请输入邀请码"></el-input>
                </template>
            </el-form-item>
            <el-form-item prop="username" label="用户名">
                <el-input type="text" v-model="ruleForm.username" auto-complete="off" placeholder="请输入3-25个字母或数字"></el-input>
            </el-form-item>
            <el-form-item prop="nickname" label="用户昵称">
                <el-input type="text" v-model="ruleForm.nickname" auto-complete="off" placeholder="请输入2-10个不为纯数字的用户昵称"></el-input>
            </el-form-item>
            <el-form-item  prop="pwd" label="登录密码">
                <el-input type="password" v-model="ruleForm.pwd" auto-complete="new-password" placeholder="登录密码"></el-input>
            </el-form-item>
            <el-form-item  prop="pwd2" label="重复密码">
                <el-input type="password" v-model="ruleForm.pwd2" auto-complete="off" placeholder="重复密码"></el-input>
            </el-form-item>
            <el-form-item  prop="qq" label="QQ号码" v-if="wayCommon">
                <el-input type="tel" v-model="ruleForm.qq" auto-complete="off" placeholder="QQ号码"></el-input>
            </el-form-item>
            <el-form-item  prop="tel" label="手机号码" v-if="wayTel">
                <el-input type="tel" v-model="ruleForm.tel" auto-complete="off" placeholder="手机号码"></el-input>
            </el-form-item>
            <el-form-item prop="yzm" label="验证码" v-if="isYzm && wayTel">
                <el-input v-model.number="ruleForm.yzm" type="tel" class="yzm" placeholder="验证码"></el-input>
                <el-button class="btn-yzm" type="primary" plain @click.native="sendSms('tel')" v-if="smsState">{{text}}</el-button>
                <el-button class="btn-yzm" type="info" plain disabled v-else>{{text}}</el-button>
            </el-form-item>
            <el-form-item>
                <el-button class="btn-full" type="danger" @click="submitForm('ruleForm')" :loading="loading">立即注册</el-button>
                <el-checkbox v-model="isCheck">我同意</el-checkbox><a @click="regVisible = true" class="link">《用户注册协议》</a>
            </el-form-item>
            <el-alert v-if="errMsg.length"
                      :title="errMsg"
                      :type="type"
                      show-icon
                      :closable="false">
            </el-alert>
        </el-form>
        <!--用户注册协议-->
        <el-dialog title="用户注册协议" :visible.sync="regVisible" :lock-scroll = false :center="true" top = 0 width="60%">
            <div class="service-cont">{$company.user_web}</div>
            <span slot="footer" class="dialog-footer">
                <el-button type="primary" @click="regVisible = false">我知道了</el-button>
            </span>
        </el-dialog>
    </div>
</template>
{include file='web@common/simple_foot' /}
<script type="text/javascript">
    $(function () {
        var regWay = '{$company.reg_way}'.split(',');
        //注册组件
        Vue.component("tel-reg", {
            template: '#telReg',
            data: function data() {
                var _this = this;

                var validateName = function validateName(rule, value, callback) {
                    var reg = /^[0-9]{2,10}$/;
                    if (value === '') {
                        callback(new Error('请输入用户昵称'));
                    } else {
                        if (reg.test(value)) {
                            callback(new Error('用户昵称必须由2-10个不为纯数字的组成'));
                        }
                        callback();
                    }
                };
                var validatePass = function validatePass(rule, value, callback) {
                    if (value === '') {
                        callback(new Error('请输入密码'));
                    } else {
                        if (_this.ruleForm.pwd !== '') {
                            _this.$refs.ruleForm.validateField('pwd2');
                        }
                        callback();
                    }
                };
                var validatePass2 = function validatePass2(rule, value, callback) {
                    if (value === '') {
                        callback(new Error('请再次输入密码'));
                    } else if (value !== _this.ruleForm.pwd) {
                        callback(new Error('两次输入密码不一致!'));
                    } else {
                        callback();
                    }
                };
                return {
                    isYzm: parseInt('{$system.tel_checked}'), //是否开启短信接口
                    isCode: parseInt('{$system.is_reg_code}'), //邀请码是否必须
                    regVisible: false, //用户注册协议
                    wayTel: parseInt('{$data.tel}'),//手机注册是否开启
                    wayCommon: parseInt('{$data.common}'),
                    ruleForm: { //表单数据
                        tel: '',
                        yzm: '',
                        username: '',
                        nickname: '',
                        pwd: '',
                        pwd2: '',
                        code:"{$code|default=''}",
                        qq:''
                    },
                    isCheck: true,
                    rules: { //表单验证
                        code: [{ required: true, message: '邀请码不能为空', trigger: 'blur' }],
                        username: [{ required: true, message: '用户名不能为空', trigger: 'blur' },{pattern: /^[a-zA-Z0-9]{3,25}$/, message: '用户名只能由3-25位字母或数字组成', trigger: 'blur' }],
                        nickname: [{ required: true, validator: validateName, trigger: 'blur' }],
                        pwd: [{ required: true, validator: validatePass, trigger: 'blur' }],
                        pwd2: [{ required: true, validator: validatePass2, trigger: 'blur' }],
                        qq: [{ required: true, message: 'QQ号码不能为空', trigger: 'blur' }, { pattern: /^[1-9][0-9]{4,14}$/, message: '请输入正确的QQ号码', trigger: 'blur' }],
                        tel: [{ required: true, message: '手机号不能为空', trigger: 'blur' }, { pattern: /^1[3-9]{1}[0-9]{9}$/, message: '请输入正确的手机号', trigger: 'blur' }],
                        yzm: [{ required: true, message: '验证码不能为空', trigger: 'blur' }, { pattern: /^\d+$/, message: '请输入正确的验证码', trigger: 'change' }]
                    },
                    errMsg: '', //错误提示
                    loading: false,
                    text: '获取验证码',
                    smsState: true,
                    countDown: 120,
                    type: 'error'
                };
            },

            methods: {
                //发送验证码
                sendSms: function() {
                    var _this2 = this;
                    if (!this.ruleForm.code) {
                        this.$message({
                            showClose: true,
                            message: '邀请码不能为空',
                            type: 'error'
                        });
                        return false;
                    }
                    if (!this.ruleForm.username) {
                        this.$message({
                            showClose: true,
                            message: '用户名不能为空',
                            type: 'error'
                        });
                        return false;
                    }
                    if (!this.ruleForm.nickname) {
                        this.$message({
                            showClose: true,
                            message: '用户昵称不能为空',
                            type: 'error'
                        });
                        return false;
                    }
                    if (!this.ruleForm.pwd) {
                        this.$message({
                            showClose: true,
                            message: '请输入密码',
                            type: 'error'
                        });
                        return false;
                    }
                    if (!this.ruleForm.pwd2) {
                        this.$message({
                            showClose: true,
                            message: '请重复输入密码',
                            type: 'error'
                        });
                        return false;
                    }
                    if (this.countDown != 120) return false;
                    var reg = /^1[3-9]{1}[0-9]{9}$/;
                    var res = reg.test(this.ruleForm.tel);
                    if (!res) {
                        this.$message({
                            showClose: true,
                            message: '手机号格式不正确，请输入正确的手机号',
                            type: 'error'
                        });
                        return false;
                    }
                    $.get('/index/reg/sendsms', {
                        tel: this.ruleForm.tel
                    }, function (res) {
                        if (!res.err) {
                            _this2.smsState = false;
                            _this2.text = "已发送(" + _this2.countDown + ")";
                            var interval = setInterval(function () {
                                _this2.countDown = _this2.countDown - 1;
                                if (_this2.countDown == 0) {
                                    _this2.text = '获取验证码';
                                    _this2.countDown = 120;
                                    clearInterval(interval);
                                    _this2.smsState = true;
                                    return;
                                }
                                _this2.text = "已发送(" + _this2.countDown + ")";
                            }, 1000);
                        } else {
                            _this2.$message({
                                showClose: true,
                                message: res.msg,
                                type: 'error'
                            });
                        }
                    });
                },
                submitForm: function(formName) {
                    var _this3 = this;
                    _this3.errMsg = '';
                    _this3.$refs[formName].validate(function (valid) {
                        if (valid) {
                            _this3.loading = true;
                            var data={
                                username: _this3.ruleForm.username,
                                nickname: _this3.ruleForm.nickname,
                                password: _this3.ruleForm.pwd,
                                password2: _this3.ruleForm.pwd2
                            }
                            if(_this3.wayCommon){
                                data['qq'] = _this3.ruleForm.qq
                            }
                            if(_this3.wayTel){
                                data['tel'] = _this3.ruleForm.tel
                            }
                            if(_this3.isYzm && _this3.wayTel){
                                data['yzm'] = _this3.ruleForm.yzm
                            }
                            if(_this3.isCode){
                                data['code'] = _this3.ruleForm.code
                            }
                            $.post('{:url("Reg/reg")}', data, function (res) {
                                if (!res.err) {
                                    _this3.$message({
                                        showClose: false,
                                        message: res.msg,
                                        type: 'success'
                                    });
                                    setTimeout(function () {
                                        window.location.href = '{:url("./index")}';
                                    }, 1000);
                                } else {
                                    _this3.errMsg = res.msg;
                                }
                                _this3.loading = false;
                            });
                        } else {
                            console.log('error submit!!');
                            return false;
                        }
                    });
                }
            }
        });
        var wHeight = $(window).height()
        new Vue({
            el: '#app',
            data: {
                wHeight:wHeight - 343,//内容高度
            },
        });
    });
</script>