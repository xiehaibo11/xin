{include file='common@common/head' /}
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="__STATIC__/css/user.css">
<script src="/static/js/loadpage.js"></script>
<script src="/static/js/vue-c-component.js"></script>
<link rel="stylesheet" href="/static/plugin/bbs/css/share.css"/>
<link rel="stylesheet" href="__STATIC__/plugin/bbs/css/style.css?a=2">
<body>

<header class="header">
    <div class="header-nav">
        <a class="nav-word" id="cancleBtn" href="javascript:history.go(-1);"><i class="icon-svg icon_left"></i></a>
    </div>
    <div class="header-center">帖子详情</div>
    <div class="header-right"><a href="/index/"><i class="iconfont icon-home" style="color:#666;font-size:0.9rem; "></i></a></div>
</header>
<div class="p-height"></div>
<div id="app" class="app_init paddin-top">
    <div id="content" style="overflow: hidden;margin-bottom: 0.5rem;">
        <div class="detail">
            <div class="card-header flex-box" style="overflow: hidden;margin-bottom: .5rem">
                <div>
                    <i class="icon-svg d-lz_photo" :style="{backgroundImage: 'url(' + info.photo +')'}"></i>
                </div>
                <div class="flex text-align-left">
                    <a class="d-username getid">{{info.nickname}}</a>
                    <span class="datetime2">{{item.create_time}}</span>
                </div>
            </div>
            <input type="hidden" name="msg" value=""/>
            <div class="card-content">
                <div class="card-content-inner" v-html="contents"></div>
                <div style="text-align:center">
                    <div v-for="img in imgArr">
                        <img v-if="img" :src="img" alt=""/>
                    </div>
                </div>
            </div>
        </div>
        <div class="massage_dt">
            <span class="d-reply" @click="rey"><i class="iconfont icon-huifu1"></i>评论</span>
            <span class="d-reply_good" @click="replayGood" :class="{ 'blue': code == 1 }">
                <b class="dz">
                    <i :class="['iconfont','icon-dianzan','dianzan',{ 'blue': code == 1 },{ 'zblue': isz == 1 }]"></i>
                    <em :class="{ 'blue': code == 1 }">{{item.goodnum}}</em>
                </b>
            </span>
            <span id="share"><i class="iconfont icon-fenxiang"></i>分享</span>
        </div>
    </div>

    <!--评论 开始-->
    <div id="comment" class=" new_comment hide" style="margin-top: 0;">
        <div class="comment-tit"><i class="iconfont icon-pinglun" style="color:#ec522d;font-size:0.8rem; "></i> 全部评论<span>（{{item.takenum}}）</span></div>
        <loading-box  :url="url"  :list="re_list"  class="list-arrow"  load="正在加载"  nodata=" " loaded="没有更多评论了">
            <template scope="props">
                <template v-for="item of props.list">
                    <action-list :item="item"></action-list>
                </template>
                <div  id="nodata" class='text-align-c no-comment hide'  v-if="re_list.length ==0">
                    <p><i class='iconfont icon-pinglunweikong-copy' style='color:#616369;font-size:2.8rem; '></i></p>
                    <p>沙发还空着，快来抢吧~</p>
                </div>
            </template>
        </loading-box>
    </div>
    <!--评论 结束-->
    <transition name="slide">
        <div  v-if="state" class="gg hide" id="ggs">
            <textarea style="width:100%" v-model="rContent" name="content" :placeholder="rName" rows="4" cols="30" style="resize:none"></textarea>
            <button class="btn btn-warning btn-fill" @click="oReplay">发布</button>
            <button class="btn gray" @click="rey">取消</button>
        </div>
    </transition>
</div>
<template id="actionList">
    <div class="detail">
        <div class="reply_t flex-box">
            <i class="icon-svg hfphoto" :style="{backgroundImage: 'url(' + item.userinfo.photo +')'}"></i>
            <a class="d-username flex text-align-left" style="padding-left: 2px;line-height: 28px;font-size: 0.7rem;">{{item.userinfo.nickname}}</a>
        </div>
        <div class="r-card-cont">
            <div class="card-content-inner"><p>{{item.content}}</p></div>
            <div class="h_re flex-box"  @click="showReplyBox">
                <span class="datetime2" style="margin-left: 0">{{item.create_time}}</span>
                <span class="reply_again" style="margin-left: 5px;">· 回复ta</span>
            </div>
            <!--二次回复 开始-->
            <div v-if="replay.length!=0" class="r_comment" id="rbody">
                <span v-for="(value,key,index) in replay" v-if="key <3"  class="cblock" >
                    <span style="color: #ffa726;" id="rcopy">{{value.userinfo.nickname}}：</span>{{value.content}}
                </span>
                <span class="cblock viewMore" v-if="replaynum > 3"  @click ="toDetail">查看全部<em>{{replaynum}}</em>条评论</span>
            </div>
            <!--二次回复 结束-->
        </div>
        <transition name="slide">
        <div v-if="isReply" class="gg">
            <textarea style="width:100%" v-model="rContent"  name="content"  :placeholder="rPlace"  rows="4" cols="30" style="resize:none"></textarea>
            <button class="btn btn-warning btn-fill"  @click="reply">发布</button>
            <button class="btn gray"  @click="showReplyBox">取消</button>
        </div>
        </transition>
    </div>
</template>
<!--分享弹窗 开始-->
    <div class="screenW">
        <div class="subW">
            <div class="info">
                <div class="shareBox">
                    <h2>请选择您的分享方式：</h2>
                    <div class="bdsharebuttonbox" style="padding: 0.5rem 0">
                        <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
                        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
                        <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友">QQ</a>
                        <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
                        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
                        <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣">豆瓣网</a>
                    </div>
                    <div class="bdsharebuttonbox" style="display: none;">
                        <a href="#" onclick="return false;" class="popup_more" data-cmd="more">+</a>
                    </div>
                </div>
            </div>
            <div class="close">关闭</div>
        </div>
    </div>
    <!--分享弹窗 结束-->
<script type="text/javascript" >
    'use strict';

    $(function () {
        var showReply = { id: 0 };
        Vue.component('action-list', {
            props: ['item'],
            template: '#actionList',
            data: function data() {
                return {
                    rPlace: '',
                    rContent: '' //二次回复内容
                };
            },
            computed: {
                isReply: function isReply() {
                    return showReply.id == this.item.id;
                },
                replay: function replay() {
                    //二次回复列表
                    return this.item.data.data;
                },
                replaynum: function replaynum() {
                    //二次回复总数
                    return this.item.data.data.length;
                }
            },
            methods: {
                toDetail: function toDetail() {
                    //进入回复详情
                    window.location.href = "/index/bbs/r_detail/id/" + this.item.id;
                },
                showReplyBox: function showReplyBox() {
                    showReply.id = showReply.id == this.item.id ? 0 : this.item.id;
                    vm.state = false;
                    this.rPlace = '回复' + this.item.userinfo.nickname;
                },
                reply: function reply() {
                    var _this = this;
                    if (_this.rContent == '') {
                        $.msg('回复内容不能为空');
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "{:Url('index/bbs/reply')}",
                            data: { pid: _this.item.pid, tid: _this.item.id, content: _this.rContent },
                            success: function success(res) {
                                var data = res[0];
                                _this.item.data.data.unshift(data);
                                $.msg('回复成功！');
                                _this.rContent = "";
                                showReply.id = 0;
                            }
                        });
                    }
                }
    
            }
    
        });
    
        var vm = new Vue({
            el: '#app',
            data: {
                item: [],
                imgArr: [],
                contents: '', //文章内容
                url: '', //评论列表路径
                code: '', //点赞状态
                isz: '',
                rContent: '', //回复内容
                showReply: showReply,
                state: false,
                info: '',
                rName: '',
                re_list: []
            },
            created: function created() {
                var _this2 = this;
    
                //获取url中的参数
                var arr = location.href.split('/').pop().split('.');
                var id = arr[arr.length - 1];
                this.url = '/index/bbs/detailInfo/id/' + id;
                $.get('/index/bbs/detailOne/id/' + id, function (res) {
                    _this2.$set(_this2, 'item', res);
                    _this2.$set(_this2, 'imgArr', res.Imgall.images);
                    _this2.code = res.good;
                    _this2.info = res.userinfo;
                    _this2.contents = replace_em(res.content);
                    $('#app').removeClass('app_init');
                    $('#comment').removeClass('hide');
                    $('#nodata').removeClass('hide');
                });
                $.get('/index/bbs/detailInfo/id/' + id, function (res) {
                    _this2.$set(_this2, 're_list', res.data);
                });
                $('#ggs').removeClass('hide');
            },
            methods: {
                replayGood: function replayGood() {
                    // 点赞
                    var _this = this;
                    $.post("/index/bbs/gooder", {
                        id: _this.item.id
                    }, function (res) {
                        if (res.code == 1) {
                            $.msg(res.msg);
                            _this.item.goodnum = _this.item.goodnum + 1;
                            _this.code = 1;
                            _this.isz = 1;
                        } else if (res.code == 0) {
                            $.msg(res.msg);
                            _this.item.goodnum = _this.item.goodnum - 1;
                            _this.code = 0;
                            _this.isz = 0;
                        }
                    });
                },
                rey: function rey() {
                    this.state = this.state == true ? false : true;
                    this.showReply.id = 0;
                    this.rName = '回复楼主' + this.info.nickname;
                },
                oReplay: function oReplay() {
                    var _this = this;
                    if (_this.rContent == '') {
                        $.msg('评论内容不能为空');
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "{:Url('index/bbs/reply')}",
                            data: { pid: _this.item.id, tid: 0, content: _this.rContent },
                            success: function success(res) {
                                var data = res[0];
                                _this.re_list.unshift(data);
                                data['data'] = { data: [] };
                                $.msg('评论成功！');
                                _this.rContent = "";
                                _this.state = false;
                                _this.item.takenum = _this.item.takenum + 1;
                            }
                        });
                    }
                }
            }
        });
        //替换表情
        var replace_em = function replace_em(str) {
            str = str.replace(/\</g, '&lt;');
            str = str.replace(/\>/g, '&gt;');
            str = str.replace(/\n/g, '<br/>');
            str = str.replace(/\[em_([0-9]*)\]/g, '<img src="/static/images/emoji/$1.gif" border="0" />');
            return str;
        };
    });
</script>
<script src="/static/plugin/bbs/js/share.js"></script>
