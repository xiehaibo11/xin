{include file='common/head' /}

<div class="box-padding" style="padding-top: 20px">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">下级用户管理</h3>
        </div>
        <div class="panel-body">
            <!-- 搜索栏 -->
            <div class="row" style="margin-bottom: 15px;">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索用户名或昵称">
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" onclick="searchUsers()">
                                <i class="glyphicon glyphicon-search"></i> 搜索
                            </button>
                        </span>
                    </div>
                </div>
                <div class="col-md-6 text-right">
                    <button class="btn btn-success" onclick="showCreateAgent()">
                        <i class="glyphicon glyphicon-plus"></i> 开通代理
                    </button>
                </div>
            </div>

            <!-- 用户列表表格 -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>昵称</th>
                            <th>代理等级</th>
                            <th>信用额度</th>
                            <th>余额</th>
                            <th>注册时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- 用户数据将通过AJAX加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div class="text-center">
                <nav aria-label="用户列表分页">
                    <ul class="pagination" id="pagination">
                        <!-- 分页将通过JavaScript生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 开通代理模态框 -->
<div class="modal fade" id="createAgentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">开通代理账号</h4>
            </div>
            <div class="modal-body">
                <form id="createAgentForm" class="form-horizontal">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">用户名 <span class="text-danger">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="username" name="username" placeholder="4-20位字母数字组合">
                                    <div class="text-danger" id="username-error"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">密码 <span class="text-danger">*</span></label>
                                <div class="col-sm-8">
                                    <input type="password" class="form-control" id="password" name="password" placeholder="6-20位密码">
                                    <div class="text-danger" id="password-error"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">确认密码 <span class="text-danger">*</span></label>
                                <div class="col-sm-8">
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="再次输入密码">
                                    <div class="text-danger" id="confirm_password-error"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">昵称 <span class="text-danger">*</span></label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="nickname" name="nickname" placeholder="2-20位昵称">
                                    <div class="text-danger" id="nickname-error"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">代理等级 <span class="text-danger">*</span></label>
                                <div class="col-sm-8">
                                    <select class="form-control" id="agent_level" name="agent_level">
                                        <option value="1">1级代理</option>
                                        <option value="2">2级代理</option>
                                        <option value="3">3级代理</option>
                                    </select>
                                    <div class="text-danger" id="agent_level-error"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">佣金比例</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="commission_rate" name="commission_rate" placeholder="0-100" min="0" max="100" step="0.1">
                                        <span class="input-group-addon">%</span>
                                    </div>
                                    <div class="text-danger" id="commission_rate-error"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">初始额度</label>
                                <div class="col-sm-8">
                                    <div class="input-group">
                                        <span class="input-group-addon">¥</span>
                                        <input type="number" class="form-control" id="initial_quota" name="initial_quota" placeholder="0.00" min="0" step="0.01">
                                    </div>
                                    <div class="text-danger" id="initial_quota-error"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">联系方式</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="phone" name="phone" placeholder="手机号码">
                                    <div class="text-danger" id="phone-error"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">备注说明</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" id="remark" name="remark" rows="3" placeholder="可选的备注信息"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateAgent()" id="submitBtn">
                    <i class="glyphicon glyphicon-ok"></i> 确认开通
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(function() {
    loadUserList();
});

// 加载用户列表
function loadUserList(page = 1, search = '') {
    $.ajax({
        url: '/index/agents/getUserList',
        type: 'POST',
        data: {
            page: page,
            search: search
        },
        dataType: 'json',
        success: function(response) {
            if (response.code === 1) {
                renderUserTable(response.data.list);
                renderPagination(response.data.pagination);
            } else {
                showMessage('error', response.msg || '加载用户列表失败');
            }
        },
        error: function() {
            showMessage('error', '网络请求失败，请稍后重试');
        }
    });
}

// 渲染用户表格
function renderUserTable(users) {
    var tbody = $('#userTableBody');
    tbody.empty();
    
    if (users.length === 0) {
        tbody.append('<tr><td colspan="9" class="text-center text-muted">暂无用户数据</td></tr>');
        return;
    }
    
    users.forEach(function(user) {
        var statusBadge = user.status == 1 ? 
            '<span class="label label-success">正常</span>' : 
            '<span class="label label-danger">冻结</span>';
            
        var agentLevelText = user.agent_level > 0 ? user.agent_level + '级代理' : '普通用户';
        
        var actionButtons = `
            <div class="btn-group-vertical btn-group-xs" role="group">
                <button class="btn btn-info" onclick="viewUser(${user.id})" title="查看详情">
                    <i class="glyphicon glyphicon-eye-open"></i>
                </button>
                <button class="btn btn-warning" onclick="editUser(${user.id})" title="编辑用户">
                    <i class="glyphicon glyphicon-edit"></i>
                </button>
                <button class="btn btn-primary" onclick="adjustQuota(${user.id})" title="调整额度">
                    <i class="glyphicon glyphicon-credit-card"></i>
                </button>
                <button class="btn ${user.status == 1 ? 'btn-danger' : 'btn-success'}" 
                        onclick="toggleUserStatus(${user.id}, ${user.status})" 
                        title="${user.status == 1 ? '冻结用户' : '解冻用户'}">
                    <i class="glyphicon ${user.status == 1 ? 'glyphicon-ban-circle' : 'glyphicon-ok-circle'}"></i>
                </button>
            </div>
        `;
        
        var row = `
            <tr>
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.nickname || '-'}</td>
                <td>${agentLevelText}</td>
                <td class="text-primary">¥${user.quota || 0}</td>
                <td class="text-success">¥${user.money || 0}</td>
                <td>${user.create_time}</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 搜索用户
function searchUsers() {
    var search = $('#searchInput').val().trim();
    loadUserList(1, search);
}

// 显示开通代理模态框
function showCreateAgent() {
    $('#createAgentModal').modal('show');
    $('#createAgentForm')[0].reset();
    $('.text-danger').text('');
}

// 提交开通代理表单
function submitCreateAgent() {
    var formData = {
        username: $('#username').val().trim(),
        password: $('#password').val(),
        confirm_password: $('#confirm_password').val(),
        nickname: $('#nickname').val().trim(),
        agent_level: $('#agent_level').val(),
        commission_rate: $('#commission_rate').val(),
        initial_quota: $('#initial_quota').val(),
        phone: $('#phone').val().trim(),
        remark: $('#remark').val().trim()
    };
    
    // 前端验证
    if (!validateCreateAgentForm(formData)) {
        return;
    }
    
    // 显示加载状态
    $('#submitBtn').prop('disabled', true).html('<i class="glyphicon glyphicon-refresh glyphicon-spin"></i> 处理中...');
    
    $.ajax({
        url: '/index/agents/createAgent',
        type: 'POST',
        data: formData,
        dataType: 'json',
        success: function(response) {
            if (response.code === 1) {
                showMessage('success', response.msg || '代理开通成功！');
                $('#createAgentModal').modal('hide');
                loadUserList(); // 刷新用户列表
            } else {
                showMessage('error', response.msg || '代理开通失败');
            }
        },
        error: function() {
            showMessage('error', '网络请求失败，请稍后重试');
        },
        complete: function() {
            $('#submitBtn').prop('disabled', false).html('<i class="glyphicon glyphicon-ok"></i> 确认开通');
        }
    });
}

// 表单验证
function validateCreateAgentForm(data) {
    var isValid = true;
    $('.text-danger').text('');
    
    if (!data.username) {
        $('#username-error').text('用户名不能为空');
        isValid = false;
    } else if (!/^[a-zA-Z0-9]{4,20}$/.test(data.username)) {
        $('#username-error').text('用户名必须是4-20位字母数字组合');
        isValid = false;
    }
    
    if (!data.password) {
        $('#password-error').text('密码不能为空');
        isValid = false;
    } else if (data.password.length < 6 || data.password.length > 20) {
        $('#password-error').text('密码长度必须在6-20位之间');
        isValid = false;
    }
    
    if (data.password !== data.confirm_password) {
        $('#confirm_password-error').text('两次输入的密码不一致');
        isValid = false;
    }
    
    if (!data.nickname) {
        $('#nickname-error').text('昵称不能为空');
        isValid = false;
    } else if (data.nickname.length < 2 || data.nickname.length > 20) {
        $('#nickname-error').text('昵称长度必须在2-20位之间');
        isValid = false;
    }
    
    if (data.phone && !/^1[3-9]\d{9}$/.test(data.phone)) {
        $('#phone-error').text('请输入正确的手机号码');
        isValid = false;
    }
    
    return isValid;
}

// 显示消息提示
function showMessage(type, message) {
    var alertClass = 'alert-info';
    switch(type) {
        case 'success': alertClass = 'alert-success'; break;
        case 'error': alertClass = 'alert-danger'; break;
        case 'warning': alertClass = 'alert-warning'; break;
    }
    
    var alertHtml = `
        <div class="alert ${alertClass} alert-dismissible" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            ${message}
        </div>
    `;
    
    $('body').append(alertHtml);
    
    // 3秒后自动消失
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 3000);
}

// 其他功能函数（占位符）
function viewUser(userId) {
    showMessage('info', '查看用户功能开发中...');
}

function editUser(userId) {
    showMessage('info', '编辑用户功能开发中...');
}

function adjustQuota(userId) {
    showMessage('info', '调整额度功能开发中...');
}

function toggleUserStatus(userId, currentStatus) {
    var action = currentStatus == 1 ? '冻结' : '解冻';
    if (confirm(`确定要${action}该用户吗？`)) {
        showMessage('info', `${action}用户功能开发中...`);
    }
}
</script>

{include file='common/foot' /}
